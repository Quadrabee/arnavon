services:

  api:
    depends_on:
      rabbitmq:
        condition: service_healthy
    image: quadrabee/arnavon
    ports:
      - 3000:80
    command: ["start:api", "-p", "80"]
    volumes:
      - ./config.yaml:/arnavon/config.yaml
      - ./schema.fio:/arnavon/schema.fio
      - ./schema.world.js:/arnavon/schema.world.js
      - ./lib:/arnavon/lib

  workers:
    depends_on:
      rabbitmq:
        condition: service_healthy
      fakesmtp:
        condition: service_started
    image: example/consumers
    build:
      context: consumers
      dockerfile: Dockerfile
    ports:
      - 3002:80
    command: ["start:consumer", "-p", "80", '--all']
    volumes:
      - ./config.yaml:/arnavon/config.yaml
      - ./schema.fio:/arnavon/schema.fio
      - ./schema.world.js:/arnavon/schema.world.js
      - ./consumers:/arnavon/consumers
      - ./lib:/arnavon/lib

  fakesmtp:
    image: reachfive/fake-smtp-server
    command: ["node", "index.js", "-s", "25", "--debug"]
    ports:
      - 1080:1080

  rabbitmq:
    image: rabbitmq:4-management
    ports:
      - 5672:5672
      - 15672:15672
    environment:
      RABBITMQ_DEFAULT_USER: rabbit
      RABBITMQ_DEFAULT_PASS: rabbit
    volumes:
      # Enable shovel plugins for DLQ requeue functionality
      - ./rabbitmq/enabled_plugins:/etc/rabbitmq/enabled_plugins
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5

  webspicy:
    build: ./webspicy
    depends_on:
      - api
    command: ["tail", "-f", "/dev/null"]
    volumes:
      - ./webspicy:/formalspec
